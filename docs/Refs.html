<!DOCTYPE html>

<html>
<head>
  <title>Refs.hs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Eval.html">
                Eval.hs
              </a>
            
              
              <a class="source" href="IO.html">
                IO.hs
              </a>
            
              
              <a class="source" href="Interfaces.html">
                Interfaces.hs
              </a>
            
              
              <a class="source" href="Main.html">
                Main.hs
              </a>
            
              
              <a class="source" href="Parser.html">
                Parser.hs
              </a>
            
              
              <a class="source" href="Primitives.html">
                Primitives.hs
              </a>
            
              
              <a class="source" href="Refs.html">
                Refs.hs
              </a>
            
              
              <a class="source" href="Types.html">
                Types.hs
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Refs.hs</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="module"><span class="keyword">module</span> Refs <span class="keyword">where</span></span>

<span class="import"><span class="keyword">import</span> Text.ParserCombinators.Parsec</span>
<span class="import"><span class="keyword">import</span> System.Environment</span>
<span class="import"><span class="keyword">import</span> Control.Monad</span>
<span class="import"><span class="keyword">import</span> Control.Monad.Error</span>
<span class="import"><span class="keyword">import</span> System.IO</span>
<span class="import"><span class="keyword">import</span> Data.IORef</span>

<span class="import"><span class="keyword">import</span> Types</span>

<span class="title">isBound</span> :: <span class="type">Env</span> -&gt; <span class="type">String</span> -&gt; <span class="type">IO</span> <span class="type">Bool</span>
<span class="title">isBound</span> envRef var = readIORef envRef &gt;&gt;= return . maybe <span class="type">False</span> (const <span class="type">True</span>) . lookup var</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Get variable</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">getVar</span> :: <span class="type">Env</span> -&gt; <span class="type">String</span> -&gt; <span class="type">IOThrowsError</span> <span class="type">LispVal</span>
<span class="title">getVar</span> envRef var  =  <span class="keyword">do</span> env &lt;- liftIO $ readIORef envRef
                         maybe (throwError $ <span class="type">UnboundVar</span> <span class="string">"Getting an unbound variable"</span> var)
                               (liftIO . readIORef)
                               (lookup var env)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>Render Environment</h2>
<p>Gets all environment definitions and selects the key elements as a <code>LispVal</code>.  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">renderEnv</span> :: <span class="type">Env</span> -&gt; <span class="type">IOThrowsError</span> [<span class="type">LispVal</span>]
<span class="title">renderEnv</span> envRef = <span class="keyword">do</span>
    env &lt;- liftIO $ readIORef envRef
    <span class="keyword">let</span> (keys, vals) = unzip env <span class="keyword">in</span> return $ (map (\k -&gt; <span class="type">String</span> k) keys)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2>Set Variable</h2>
<p>Performs a lookup on the environment associations to find a variable value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">setVar</span> :: <span class="type">Env</span> -&gt; <span class="type">String</span> -&gt; <span class="type">LispVal</span> -&gt; <span class="type">IOThrowsError</span> <span class="type">LispVal</span>
<span class="title">setVar</span> envRef var value = <span class="keyword">do</span> env &lt;- liftIO $ readIORef envRef
                             maybe (throwError $ <span class="type">UnboundVar</span> <span class="string">"Setting an unbound variable"</span> var) 
                                   (liftIO . (flip writeIORef value))
                                   (lookup var env)
                             return value</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Define variable</h2>
<p>Either finds and modifies an association on the <code>env</code> or creates a new one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">defineVar</span> :: <span class="type">Env</span> -&gt; <span class="type">String</span> -&gt; <span class="type">LispVal</span> -&gt; <span class="type">IOThrowsError</span> <span class="type">LispVal</span>
<span class="title">defineVar</span> envRef var value = <span class="keyword">do</span> 
    alreadyDefined &lt;- liftIO $ isBound envRef var 
    <span class="keyword">if</span> alreadyDefined 
       <span class="keyword">then</span> setVar envRef var value &gt;&gt; return value
       <span class="keyword">else</span> liftIO $ <span class="keyword">do</span> 
          valueRef &lt;- newIORef value
          env &lt;- readIORef envRef
          writeIORef envRef ((var, valueRef) : env)
          return value</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2>Bind a series of variables</h2>
<p>Converts a series of associations to an environment. Useful in initiation and <code>evalenv</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">bindVars</span> :: <span class="type">Env</span> -&gt; [(<span class="type">String</span>, <span class="type">LispVal</span>)] -&gt; <span class="type">IO</span> <span class="type">Env</span>
<span class="title">bindVars</span> envRef bindings = readIORef envRef &gt;&gt;= extendEnv bindings &gt;&gt;= newIORef
    <span class="keyword">where</span> extendEnv bindings env = liftM (++ env) (mapM addBinding bindings)
          addBinding (var, value) = <span class="keyword">do</span> ref &lt;- newIORef value
                                       return (var, ref)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
