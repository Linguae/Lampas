<!DOCTYPE html>

<html>
<head>
  <title>Eval.hs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Eval.html">
                Eval.hs
              </a>
            
              
              <a class="source" href="IO.html">
                IO.hs
              </a>
            
              
              <a class="source" href="Interfaces.html">
                Interfaces.hs
              </a>
            
              
              <a class="source" href="Main.html">
                Main.hs
              </a>
            
              
              <a class="source" href="Parser.html">
                Parser.hs
              </a>
            
              
              <a class="source" href="Primitives.html">
                Primitives.hs
              </a>
            
              
              <a class="source" href="Refs.html">
                Refs.hs
              </a>
            
              
              <a class="source" href="Types.html">
                Types.hs
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Eval.hs</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The <code>Eval</code> module handles evaluation of already parsed expressions. Generally the evaluation is done by pattern matching, execution of functions, and recursion upon <code>eval</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="module"><span class="keyword">module</span> Eval <span class="keyword">where</span></span>

<span class="import"><span class="keyword">import</span> Text.ParserCombinators.Parsec</span>
<span class="import"><span class="keyword">import</span> System.Environment</span>
<span class="import"><span class="keyword">import</span> Control.Monad</span>
<span class="import"><span class="keyword">import</span> Control.Monad.Error</span>
<span class="import"><span class="keyword">import</span> System.IO</span>
<span class="import"><span class="keyword">import</span> Data.IORef</span>

<span class="import"><span class="keyword">import</span> Types</span>
<span class="import"><span class="keyword">import</span> Refs</span>
<span class="import"><span class="keyword">import</span> IO</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Apply Arguments to Functions</h2>
<p>Functions are either primitive or user-defined. Application simply pattern matches against these and assuming no errors, fires the underlying function with passed arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">apply</span> :: <span class="type">LispVal</span> -&gt; [<span class="type">LispVal</span>] -&gt; <span class="type">IOThrowsError</span> <span class="type">LispVal</span>
<span class="title">apply</span> (<span class="type">PrimitiveFunc</span> func) args = liftThrows $ func args</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>Apply Arguments to User-Defined Functions</h3>
<p>Check parameter count and then bind the closure to the environment, pass arguments and evaluate the body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">apply</span> (<span class="type">Func</span> params varargs body closure) args = 
    <span class="keyword">if</span> num params /= num args &amp;&amp; varargs == <span class="type">Nothing</span>
       <span class="keyword">then</span> throwError $ <span class="type">NumArgs</span> (num params) args
       <span class="keyword">else</span> (liftIO $ bindVars closure $ zip params args) &gt;&gt;= bindVarArgs varargs &gt;&gt;= evalBody
    <span class="keyword">where</span> remainingArgs = drop (length params) args
          num = toInteger . length
          evalBody env = liftM last $ mapM (eval env) body 
          bindVarArgs arg env = <span class="keyword">case</span> arg <span class="keyword">of</span>
              <span class="type">Just</span> argName -&gt; liftIO $ bindVars env [(argName, <span class="type">List</span> $ remainingArgs)]
              <span class="type">Nothing</span> -&gt; return env 
<span class="title">apply</span> (<span class="type">IOFunc</span> func) args = func args</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2>Apply a List of Arguments to Functions</h2>
<p>A primitive function for application of arguments to a function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">applyProc</span> :: [<span class="type">LispVal</span>] -&gt; <span class="type">IOThrowsError</span> <span class="type">LispVal</span>
<span class="title">applyProc</span> [func, <span class="type">List</span> args] = apply func args
<span class="title">applyProc</span> (func : args) = apply func args</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Macros</h2>
<p>Macros rewrite expressions of a given form prior to there evaluation.</p>
<h3>Check for Rewriters of Expressions</h3>
<p>Macro rewriters are stored in the same way as traditional functions. They are merely given a special flag and fired in a different way.</p>
<p>Basic <code>defmacro</code> rewriters are checked for here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">hasRewrite</span> :: <span class="type">LispVal</span> -&gt; <span class="type">Env</span> -&gt; <span class="type">IOThrowsError</span> <span class="type">Bool</span>
<span class="title">hasRewrite</span> (<span class="type">Atom</span> name) env = liftIO $ isBound env (name ++ <span class="string">"-syntax"</span>)
<span class="title">hasRewrite</span> badAtom env = liftIO $ return <span class="type">False</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Special <code>defenvmacro</code> rewriters are handled separately and are passed the environment of the expression they are substituting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">hasEnvRewrite</span> :: <span class="type">LispVal</span> -&gt; <span class="type">Env</span> -&gt; <span class="type">IOThrowsError</span> <span class="type">Bool</span>
<span class="title">hasEnvRewrite</span> (<span class="type">Atom</span> name) env = liftIO $ isBound env (name ++ <span class="string">"-syntax-env"</span>)
<span class="title">hasEnvRewrite</span> badAtom env = liftIO $ return <span class="type">False</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>Macro Rewriters</h3>
<p>When rewriting an expression by macro, the function is accessed just like any other, then applied with the rest of the expression as argument, and the returned expression is then evaluated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">rewrite</span> env (<span class="type">Atom</span> name) args = <span class="keyword">do</span>
    func &lt;- getVar env (name ++ <span class="string">"-syntax"</span>)    
    applied &lt;- apply func args
    eval env applied
    
<span class="title">rewriteEnv</span> env (<span class="type">Atom</span> name) args = <span class="keyword">do</span>
    func &lt;- getVar env (name ++ <span class="string">"-syntax-env"</span>)    
    renderedEnv &lt;- renderEnv env
    renderedVals &lt;- mapM (\(<span class="type">String</span> val) -&gt; getVar env val) renderedEnv
    applied &lt;- apply func ((<span class="type">List</span> (map (\(key, val) -&gt; <span class="type">List</span> [key, val]) (zip renderedEnv renderedVals))):args)
    eval env applied</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2>Quasiquotations</h2>
<p>Quasiquotes allow for values to be escaped as literal via <code>,</code>. The parsing of this is made recursive by quasiquoting all sub-expressions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">evalCommas</span> (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"unquote"</span>, val]) = val
<span class="title">evalCommas</span> normalAtom = <span class="type">List</span> [<span class="type">Atom</span> <span class="string">"quasiquote"</span>, normalAtom]</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2>Evaluate LispVals</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> :: <span class="type">Env</span> -&gt; <span class="type">LispVal</span> -&gt; <span class="type">IOThrowsError</span> <span class="type">LispVal</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Pattern match against basic primitive types and return them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env val@(<span class="type">String</span> _) = return val
<span class="title">eval</span> env val@(<span class="type">Number</span> _) = return val
<span class="title">eval</span> env val@(<span class="type">Bool</span> _) = return val</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>An atom not caught as <code>quote</code>, <code>if</code>, etc. is a variable reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env (<span class="type">Atom</span> id) = getVar env id</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>quote</code> returns the literal form of quoted values, and <code>quasiquote</code> does the same, after searching for commas to parse via <code>evalCommas</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"quote"</span>, val]) = return val
<span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"quasiquote"</span>, <span class="type">List</span> args]) = <span class="keyword">do</span> 
    argVals &lt;- mapM ((eval env) . evalCommas) args
    liftIO $ return $ <span class="type">List</span> argVals
<span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"quasiquote"</span>, arg]) = liftIO $ return arg</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>if</code> statement evaluation is lazy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"if"</span>, pred, conseq, alt]) = 
    <span class="keyword">do</span> result &lt;- eval env pred
       <span class="keyword">case</span> result <span class="keyword">of</span>
         <span class="type">Bool</span> <span class="type">False</span> -&gt; eval env alt
         otherwise -&gt; eval env conseq</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2>Variable Setters &amp; Macros</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"set!"</span>, <span class="type">Atom</span> var, form]) =
    eval env form &gt;&gt;= setVar env var
<span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"define"</span>, <span class="type">Atom</span> var, form]) =
    eval env form &gt;&gt;= defineVar env var
<span class="title">eval</span> env (<span class="type">List</span> [<span class="type">Atom</span> <span class="string">"load"</span>, <span class="type">String</span> filename]) = 
    load filename &gt;&gt;= liftM last . mapM (eval env)    
<span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"define"</span> : <span class="type">List</span> (<span class="type">Atom</span> var : params) : body)) =
    makeNormalFunc env params body &gt;&gt;= defineVar env var
<span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"define"</span> : <span class="type">DottedList</span> (<span class="type">Atom</span> var : params) varargs : body)) =
    makeVarargs varargs env params body &gt;&gt;= defineVar env var</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>defmacro</code> defines functions of a special naming format.    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"defmacro"</span> : <span class="type">List</span> (<span class="type">Atom</span> var : params) : body)) =
    makeNormalFunc env params body &gt;&gt;= defineVar env (var ++ <span class="string">"-syntax"</span>)        
<span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"defmacro"</span> : <span class="type">DottedList</span> (<span class="type">Atom</span> var : params) varargs : body)) =
    makeVarargs varargs env params body &gt;&gt;= defineVar env (var ++ <span class="string">"-syntax"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><code>defenvmacro</code> defines functions of another format.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"defenvmacro"</span> : <span class="type">List</span> (<span class="type">Atom</span> var : params) : body)) =
    makeNormalFunc env params body &gt;&gt;= defineVar env (var ++ <span class="string">"-syntax-env"</span>)    
<span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"lambda"</span> : <span class="type">List</span> params : body)) =
    makeNormalFunc env params body    
<span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"lambda"</span> : <span class="type">DottedList</span> params varargs : body)) =
    makeVarargs varargs env params body
<span class="title">eval</span> env (<span class="type">List</span> (<span class="type">Atom</span> <span class="string">"lambda"</span> : varargs@(<span class="type">Atom</span> _) : body)) =
    makeVarargs varargs env [] body</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>A default S-Expression is checked for applicable macros, env-macros, and finally executed as a function call.    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">eval</span> env val@(<span class="type">List</span> (function : args)) = <span class="keyword">do</span>
    hadRewrite &lt;- hasRewrite function env
    hadEnvRewrite &lt;- hasEnvRewrite function env
    <span class="keyword">if</span> hadRewrite 
      <span class="keyword">then</span> rewrite env function args 
      <span class="keyword">else</span> <span class="keyword">if</span> hadEnvRewrite
        <span class="keyword">then</span> rewriteEnv env function args
        <span class="keyword">else</span> evalfun env val
<span class="title">eval</span> env badForm = throwError $ <span class="type">BadSpecialForm</span> <span class="string">"Unrecognized special form"</span> badForm</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>evalfun</code> is delegated to if a matching expression is not interpreted as a macro.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">evalfun</span> env (<span class="type">List</span> (function : args)) = <span class="keyword">do</span> 
    func &lt;- eval env function
    argVals &lt;- mapM (eval env) args
    apply func argVals</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2>Function Constructors</h2>
<p>Functions are made to match the <code>Func</code> type by these constructors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="title">makeFunc</span> varargs env params body = return $ <span class="type">Func</span> (map showVal params) varargs body env
<span class="title">makeNormalFunc</span> = makeFunc <span class="type">Nothing</span>
<span class="title">makeVarargs</span> = makeFunc . <span class="type">Just</span> . showVal</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
